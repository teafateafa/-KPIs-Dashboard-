<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Multi-Platform System | Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ù†Ø®Ø¨Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; transition: direction 0.3s; }
        body.ltr { font-family: 'Inter', sans-serif; direction: ltr; }
        .platform-icon { width: 24px; text-align: center; display: inline-block; margin-left: 5px; }
        .card-hover:hover { transform: translateY(-3px); transition: 0.3s; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50 border-b-4 border-blue-500">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <button onclick="toggleLanguage()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded font-bold text-sm transition">
                    <span id="langBtnText">English</span>
                </button>
                <h1 class="text-lg md:text-2xl font-bold"><i class="fas fa-network-wired mx-2"></i><span data-key="appTitle">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</span></h1>
            </div>
            <span class="text-xs md:text-sm bg-slate-800 px-3 py-1 rounded-full border border-slate-700" data-key="academyName">Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©</span>
        </div>
    </header>

    <div class="container mx-auto p-4 flex flex-col lg:flex-row gap-6">

        <!-- Sidebar: Inputs -->
        <div class="w-full lg:w-1/3 bg-white rounded-lg shadow-lg h-[85vh] flex flex-col no-print">
            <div class="p-4 border-b bg-slate-50 rounded-t-lg">
                <h2 class="text-lg font-bold text-slate-800"><i class="fas fa-edit mx-2"></i><span data-key="inputTitle">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span></h2>
                <div class="mt-2">
                    <label class="text-xs font-bold text-slate-500 block mb-1" data-key="selectMonth">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</label>
                    <select id="monthInput" class="w-full border p-2 rounded text-sm bg-white focus:outline-none focus:border-blue-500">
                        <option value="Jan">January (ÙŠÙ†Ø§ÙŠØ±)</option>
                        <option value="Feb">February (ÙØ¨Ø±Ø§ÙŠØ±)</option>
                        <option value="Mar">March (Ù…Ø§Ø±Ø³)</option>
                        <option value="Apr">April (Ø£Ø¨Ø±ÙŠÙ„)</option>
                        <option value="May">May (Ù…Ø§ÙŠÙˆ)</option>
                        <option value="Jun">June (ÙŠÙˆÙ†ÙŠÙˆ)</option>
                        <option value="Jul">July (ÙŠÙˆÙ„ÙŠÙˆ)</option>
                        <option value="Aug">August (Ø£ØºØ³Ø·Ø³)</option>
                        <option value="Sep">September (Ø³Ø¨ØªÙ…Ø¨Ø±)</option>
                        <option value="Oct">October (Ø£ÙƒØªÙˆØ¨Ø±)</option>
                        <option value="Nov">November (Ù†ÙˆÙÙ…Ø¨Ø±)</option>
                        <option value="Dec">December (Ø¯ÙŠØ³Ù…Ø¨Ø±)</option>
                    </select>
                </div>
            </div>
            
            <form id="multiPlatformForm" onsubmit="calculateReport(event)" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-6">
                <div id="platformsContainer">
                    <!-- Platforms Generated via JS -->
                </div>
            </form>

            <div class="p-4 border-t bg-slate-50 rounded-b-lg">
                <button onclick="document.getElementById('multiPlatformForm').dispatchEvent(new Event('submit'))" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-4 rounded transition shadow-md flex justify-center items-center gap-2">
                    <i class="fas fa-calculator"></i> <span data-key="genReportBtn">Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</span>
                </button>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="w-full lg:w-2/3 flex flex-col gap-6">
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-lg shadow card-hover border-r-4 border-l-4 border-blue-600">
                    <div class="text-gray-500 text-xs font-bold uppercase" data-key="totalReachLabel">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØµÙˆÙ„ / Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</div>
                    <div class="text-2xl font-bold text-blue-900 mt-1" id="grandReach">0</div>
                    <div class="text-[10px] text-gray-400" data-key="totalReachSub">Ø¹Ø¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow card-hover border-r-4 border-l-4 border-green-600">
                    <div class="text-gray-500 text-xs font-bold uppercase" data-key="totalEngLabel">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„</div>
                    <div class="text-2xl font-bold text-green-900 mt-1" id="grandEng">0</div>
                    <div class="text-[10px] text-gray-400" data-key="totalEngSub">Ù„Ø§ÙŠÙƒØŒ ÙƒÙˆÙ…Ù†ØªØŒ Ø´ÙŠØ±</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow card-hover border-r-4 border-l-4 border-purple-600">
                    <div class="text-gray-500 text-xs font-bold uppercase" data-key="topPlatformLabel">Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø£ÙØ¶Ù„</div>
                    <div class="text-xl font-bold text-purple-900 mt-1" id="topPlatformName">-</div>
                    <div class="text-[10px] text-purple-600" id="topPlatformStat">-</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="bg-white p-5 rounded-lg shadow">
                <h3 class="font-bold text-slate-700 mb-4 border-b pb-2 flex justify-between items-center">
                    <span><i class="fas fa-chart-bar mx-2"></i><span data-key="chartTitle">Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡</span></span>
                </h3>
                <div class="h-64">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="bg-white p-5 rounded-lg shadow overflow-x-auto">
                <h3 class="font-bold text-slate-700 mb-4 text-sm" data-key="tableTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„ÙƒÙ„ Ù…Ù†ØµØ©</h3>
                <table class="w-full text-right text-xs md:text-sm border-collapse">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="p-2 border-b text-start" data-key="colPlatform">Ø§Ù„Ù…Ù†ØµØ©</th>
                            <th class="p-2 border-b text-center" data-key="colContent">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</th>
                            <th class="p-2 border-b text-center" data-key="colReach">Ø§Ù„ÙˆØµÙˆÙ„/Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</th>
                            <th class="p-2 border-b text-center" data-key="colEng">Ø§Ù„ØªÙØ§Ø¹Ù„</th>
                            <th class="p-2 border-b text-center" data-key="colRate">Ø§Ù„Ù…Ø¹Ø¯Ù„ %</th>
                        </tr>
                    </thead>
                    <tbody id="detailsTableBody">
                        <tr><td colspan="5" class="p-4 text-center text-gray-400" data-key="noData">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø¶ØºØ· "Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±"</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Email Generator -->
            <div class="bg-slate-800 text-white p-6 rounded-lg shadow no-print">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-yellow-400"><i class="fas fa-envelope mx-2"></i><span data-key="emailTitle">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ù„Ù„Ù†Ø³Ø®)</span></h3>
                    <button onclick="copyEmail()" class="text-xs bg-slate-600 hover:bg-slate-500 text-white px-3 py-2 rounded transition border border-slate-500">
                        <i class="fas fa-copy"></i> <span data-key="copyBtn">Ù†Ø³Ø® Ø§Ù„Ù†Øµ</span>
                    </button>
                </div>
                <textarea id="emailTemplate" class="w-full h-64 p-4 text-sm border border-slate-600 rounded bg-slate-900 text-slate-300 focus:outline-none font-mono leading-relaxed" readonly></textarea>
                <div class="mt-3 text-end">
                    <button onclick="window.print()" class="text-xs text-slate-400 hover:text-white underline">
                        <i class="fas fa-print"></i> <span data-key="printBtn">Ø·Ø¨Ø§Ø¹Ø© PDF</span>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- Translations ---
        const translations = {
            ar: {
                appTitle: "Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„",
                academyName: "Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ù†Ø®Ø¨Ø© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©",
                inputTitle: "Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ§Øª",
                selectMonth: "Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±",
                genReportBtn: "Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±",
                totalReachLabel: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØµÙˆÙ„ / Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª",
                totalReachSub: "Ø¹Ø¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª",
                totalEngLabel: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„",
                totalEngSub: "Ù„Ø§ÙŠÙƒØŒ ÙƒÙˆÙ…Ù†ØªØŒ Ø´ÙŠØ±",
                topPlatformLabel: "Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø£ÙØ¶Ù„",
                chartTitle: "Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡",
                tableTitle: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„ÙƒÙ„ Ù…Ù†ØµØ©",
                colPlatform: "Ø§Ù„Ù…Ù†ØµØ©",
                colContent: "Ø§Ù„Ù…Ø­ØªÙˆÙ‰",
                colReach: "Ø§Ù„ÙˆØµÙˆÙ„/Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª",
                colEng: "Ø§Ù„ØªÙØ§Ø¹Ù„",
                colRate: "Ø§Ù„Ù…Ø¹Ø¯Ù„ %",
                noData: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø¶ØºØ· Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±",
                emailTitle: "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ù„Ù„Ù†Ø³Ø®)",
                copyBtn: "Ù†Ø³Ø® Ø§Ù„Ù†Øµ",
                printBtn: "Ø·Ø¨Ø§Ø¹Ø© PDF",
                // Dynamic Fields Labels
                Posts: "Ù…Ù†Ø´ÙˆØ±Ø§Øª",
                Videos: "ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª",
                Reach: "Ø§Ù„ÙˆØµÙˆÙ„",
                Engagement: "Ø§Ù„ØªÙØ§Ø¹Ù„",
                Views: "Ù…Ø´Ø§Ù‡Ø¯Ø§Øª",
                Likes: "Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª",
                Comments: "ØªØ¹Ù„ÙŠÙ‚Ø§Øª",
                Messages: "Ø±Ø³Ø§Ø¦Ù„",
                // Twitter Specific
                VerifiedFollowers: "Ù…ØªØ§Ø¨ÙØ¹ÙˆÙ† Ù…ÙˆØ«ÙÙ‘Ù‚ÙˆÙ†",
                Impressions: "Ù…Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ±",
                EngagementRateInput: "Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (Rate)",
                TwEngagements: "Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª (Engagements)",
                ProfileVisits: "Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠÙ‘",
                Replies: "Ø§Ù„Ø±Ø¯ÙˆØ¯",
                Reposts: "Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙØ¹Ø§Ø¯ Ù†Ø´Ø±Ù‡Ø§",
                Bookmarks: "Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©",
                TwShares: "Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª (Shares)"
            },
            en: {
                appTitle: "Integrated Content Ecosystem",
                academyName: "Elite International Academy",
                inputTitle: "Platform Data Input",
                selectMonth: "Select Month",
                genReportBtn: "Generate Report",
                totalReachLabel: "Total Reach / Views",
                totalReachSub: "Across all platforms",
                totalEngLabel: "Total Engagement",
                totalEngSub: "Likes, Comments, Shares",
                topPlatformLabel: "Top Performer",
                chartTitle: "Performance Comparison",
                tableTitle: "Platform Performance Details",
                colPlatform: "Platform",
                colContent: "Content",
                colReach: "Reach/Views",
                colEng: "Engagement",
                colRate: "Rate %",
                noData: "Enter data and click Generate Report",
                emailTitle: "Final Report (Ready to Copy)",
                copyBtn: "Copy Text",
                printBtn: "Print PDF",
                // Dynamic Fields Labels
                Posts: "Posts",
                Videos: "Videos",
                Reach: "Reach",
                Engagement: "Engagement",
                Views: "Views",
                Likes: "Likes",
                Comments: "Comments",
                Messages: "Messages",
                // Twitter Specific
                VerifiedFollowers: "Verified Followers",
                Impressions: "Impressions",
                EngagementRateInput: "Engagement Rate",
                TwEngagements: "Engagements (Total)",
                ProfileVisits: "Profile Visits",
                Replies: "Replies",
                Reposts: "Reposts",
                Bookmarks: "Bookmarks",
                TwShares: "Shares"
            }
        };

        let currentLang = 'ar';

        // --- Configuration: Platforms List ---
        // Each platform has a 'fields' array defining its inputs
        const platforms = [
            { 
                id: 'linkedin', name: 'LinkedIn', icon: 'fa-linkedin', color: '#0077b5',
                fields: [
                    { key: 'Posts', type: 'count' },
                    { key: 'Reach', type: 'reach' },
                    { key: 'Engagement', type: 'eng' }
                ]
            },
            { 
                id: 'facebook', name: 'Facebook', icon: 'fa-facebook', color: '#1877f2',
                fields: [
                    { key: 'Posts', type: 'count' },
                    { key: 'Reach', type: 'reach' },
                    { key: 'Engagement', type: 'eng' }
                ]
            },
            { 
                id: 'instagram', name: 'Instagram', icon: 'fa-instagram', color: '#c32aa3',
                fields: [
                    { key: 'Posts', type: 'count' },
                    { key: 'Reach', type: 'reach' },
                    { key: 'Engagement', type: 'eng' }
                ]
            },
            { 
                id: 'twitter', name: 'Twitter (X)', icon: 'fa-twitter', color: '#000000',
                fields: [ // Updated to exact list requested
                    { key: 'VerifiedFollowers', type: 'growth' }, // Ù…ØªØ§Ø¨ÙØ¹ÙˆÙ† Ù…ÙˆØ«ÙÙ‘Ù‚ÙˆÙ†
                    { key: 'Impressions', type: 'reach' }, // Ù…Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ±
                    { key: 'EngagementRateInput', type: 'info' }, // Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (Input)
                    { key: 'TwEngagements', type: 'eng' }, // Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª (Total Engagements)
                    { key: 'ProfileVisits', type: 'eng_bonus' }, // Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠÙ‘
                    { key: 'Replies', type: 'eng_part' }, // Ø§Ù„Ø±Ø¯ÙˆØ¯
                    { key: 'Likes', type: 'eng_part' }, // Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª
                    { key: 'Reposts', type: 'eng_part' }, // Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙØ¹Ø§Ø¯ Ù†Ø´Ø±Ù‡Ø§
                    { key: 'Bookmarks', type: 'eng_part' }, // Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©
                    { key: 'TwShares', type: 'eng_part' } // Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª (Shares)
                ]
            },
            { 
                id: 'tiktok', name: 'TikTok', icon: 'fa-tiktok', color: '#000000',
                fields: [ // As requested: Views, Likes, Comments
                    { key: 'Videos', type: 'count' },
                    { key: 'Views', type: 'reach' },
                    { key: 'Likes', type: 'eng_part' },
                    { key: 'Comments', type: 'eng_part' }
                ]
            },
            { 
                id: 'youtube', name: 'YouTube', icon: 'fa-youtube', color: '#ff0000',
                fields: [ // As requested: Views, Likes, Comments
                    { key: 'Videos', type: 'count' },
                    { key: 'Views', type: 'reach' },
                    { key: 'Likes', type: 'eng_part' },
                    { key: 'Comments', type: 'eng_part' }
                ]
            },
            { 
                id: 'snapchat', name: 'Snapchat', icon: 'fa-snapchat-ghost', color: '#fffc00', textColor: 'text-black',
                fields: [
                    { key: 'Videos', type: 'count' },
                    { key: 'Views', type: 'reach' },
                    { key: 'Likes', type: 'eng_part' }
                ]
            },
            { 
                id: 'whatsapp', name: 'WhatsApp Ch.', icon: 'fa-whatsapp', color: '#25d366',
                fields: [
                    { key: 'Posts', type: 'count' },
                    { key: 'Reach', type: 'reach' }, 
                    { key: 'Engagement', type: 'eng' } 
                ]
            },
            { 
                id: 'telegram', name: 'Telegram Ch.', icon: 'fa-telegram', color: '#0088cc',
                fields: [
                    { key: 'Messages', type: 'count' },
                    { key: 'Reach', type: 'reach' },
                    { key: 'Engagement', type: 'eng' }
                ]
            }
        ];

        // --- Functions ---

        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            
            // Update Body Direction/Font
            const body = document.body;
            if (currentLang === 'en') {
                body.classList.add('ltr');
                body.setAttribute('dir', 'ltr');
                document.getElementById('langBtnText').innerText = "Ø¹Ø±Ø¨ÙŠ";
            } else {
                body.classList.remove('ltr');
                body.setAttribute('dir', 'rtl');
                document.getElementById('langBtnText').innerText = "English";
            }

            // Update Static Text
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (translations[currentLang][key]) {
                    el.innerText = translations[currentLang][key];
                }
            });

            // Re-render Form Inputs to update labels
            renderForm();
            
            // Re-render Table Header text direction
            const ths = document.querySelectorAll('th');
            ths.forEach(th => th.style.textAlign = currentLang === 'en' ? 'left' : 'right');
        }

        function renderForm() {
            const container = document.getElementById('platformsContainer');
            // Save current values to restore them after re-render
            const storedValues = {};
            const inputs = container.querySelectorAll('input');
            inputs.forEach(inp => storedValues[inp.id] = inp.value);

            container.innerHTML = '';
            
            platforms.forEach(p => {
                // Generate grid based on number of fields (2 cols or 3 cols)
                const gridCols = p.fields.length > 3 ? 'grid-cols-2' : 'grid-cols-3';
                
                let fieldsHTML = '';
                p.fields.forEach(field => {
                    const label = translations[currentLang][field.key] || field.key;
                    const inputId = `${p.id}_${field.key}`;
                    const val = storedValues[inputId] || '';
                    const placeholder = field.key === 'EngagementRateInput' ? 'e.g. 5.2%' : '0';
                    const inputType = field.key === 'EngagementRateInput' ? 'text' : 'number';

                    fieldsHTML += `
                        <div>
                            <label class="block text-[10px] text-gray-500 font-bold mb-1">${label}</label>
                            <input type="${inputType}" id="${inputId}" value="${val}" class="w-full border p-1 rounded text-sm focus:border-blue-500 bg-white" placeholder="${placeholder}">
                        </div>
                    `;
                });

                const section = `
                    <div class="bg-slate-50 p-3 rounded border border-slate-200 hover:border-blue-300 transition">
                        <div class="flex items-center mb-2 font-bold text-${p.textColor ? 'slate-800' : p.id === 'tiktok' ? 'slate-800' : p.id }">
                            <i class="fab ${p.icon} w-6 text-lg" style="color:${p.color}"></i>
                            <span class="mr-2 mx-2">${p.name}</span>
                        </div>
                        <div class="grid ${gridCols} gap-2">
                            ${fieldsHTML}
                        </div>
                    </div>
                `;
                container.innerHTML += section;
            });
        }

        let comparisonChart = null;

        function initChart() {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Reach/Views', data: [], backgroundColor: '#3b82f6', borderRadius: 4 },
                        { label: 'Engagement', data: [], backgroundColor: '#22c55e', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function calculateReport(e) {
            e.preventDefault();
            
            const monthText = document.getElementById('monthInput').options[document.getElementById('monthInput').selectedIndex].text;

            let grandTotalReach = 0;
            let grandTotalEng = 0;
            let platformData = [];
            let topPlatform = { name: '-', reach: 0 };

            platforms.forEach(p => {
                let posts = 0;
                let reach = 0;
                let eng = 0;
                let details = [];

                // Iterate through dynamic fields to calculate standard KPIs
                p.fields.forEach(field => {
                    const inputElem = document.getElementById(`${p.id}_${field.key}`);
                    const val = field.key === 'EngagementRateInput' ? inputElem.value : (parseInt(inputElem.value) || 0);
                    
                    // Add to detailed list string (skip 0s unless it's text)
                    const label = translations[currentLang][field.key];
                    if (val !== 0 && val !== '') details.push(`${label}: ${val.toLocaleString()}`);

                    // Normalize Logic for Aggregation
                    if (field.type === 'count') posts = val;
                    if (field.type === 'reach') reach = val; 
                    if (field.type === 'eng') eng = val;
                    // For platforms where we sum up parts (like TikTok likes+comments)
                    // Note: Twitter "TwEngagements" (type: eng) is the TOTAL provided by user, so we take it directly.
                    // Twitter parts (Likes, Reposts...) are type 'eng_part' but since we have the total 'TwEngagements', 
                    // we should NOT double count them if 'TwEngagements' is present.
                    // Logic check: if platform has explicit 'eng' field, use that. If not, sum 'eng_part'.
                    
                    const hasExplicitEng = p.fields.some(f => f.type === 'eng');
                    if (!hasExplicitEng && field.type === 'eng_part') eng += val;
                    
                    // Bonus stats (Profile Visits) generally don't count towards standard "Engagement" metric in comparisons usually, 
                    // but often people want to see them. Let's keep them in 'details' but not add to 'eng' total to avoid inflation vs other platforms,
                    // unless specified.
                });

                grandTotalReach += reach;
                grandTotalEng += eng;

                if (reach > topPlatform.reach) {
                    topPlatform = { name: p.name, reach: reach, stat: reach.toLocaleString() };
                }

                if (details.length > 0) {
                    const er = reach > 0 ? ((eng / reach) * 100).toFixed(2) : 0;
                    platformData.push({ 
                        ...p, 
                        posts, 
                        reach, 
                        eng, 
                        er, 
                        detailsStr: details.join(' | ') 
                    });
                }
            });

            // Update UI
            document.getElementById('grandReach').innerText = grandTotalReach.toLocaleString();
            document.getElementById('grandEng').innerText = grandTotalEng.toLocaleString();
            
            const reachLabel = currentLang === 'ar' ? 'ÙˆØµÙˆÙ„/Ù…Ø´Ø§Ù‡Ø¯Ø§Øª' : 'Reach/Views';
            document.getElementById('topPlatformName').innerText = topPlatform.name;
            document.getElementById('topPlatformStat').innerText = `${topPlatform.stat} ${reachLabel}`;

            updateTable(platformData);
            updateChart(platformData);
            generateEmail(monthText, grandTotalReach, grandTotalEng, topPlatform, platformData);
        }

        function updateTable(data) {
            const tbody = document.getElementById('detailsTableBody');
            tbody.innerHTML = '';
            
            data.sort((a, b) => b.reach - a.reach);

            data.forEach(row => {
                const tr = `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-2 font-bold text-slate-700 text-start">
                            <i class="fab ${row.icon} mx-2" style="color:${row.color}"></i>${row.name}
                        </td>
                        <td class="p-2 text-center text-xs text-gray-500">${row.posts > 0 ? row.posts : '-'}</td>
                        <td class="p-2 font-bold text-center">${row.reach.toLocaleString()}</td>
                        <td class="p-2 text-center">${row.eng.toLocaleString()}</td>
                        <td class="p-2 text-blue-600 font-bold text-center">${row.er}%</td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-400">${translations[currentLang].noData}</td></tr>`;
            }
        }

        function updateChart(data) {
            comparisonChart.data.labels = data.map(d => d.name);
            comparisonChart.data.datasets[0].label = translations[currentLang].colReach;
            comparisonChart.data.datasets[1].label = translations[currentLang].colEng;
            
            comparisonChart.data.datasets[0].data = data.map(d => d.reach);
            comparisonChart.data.datasets[1].data = data.map(d => d.eng);
            comparisonChart.update();
        }

        function generateEmail(month, totalReach, totalEng, topPlatform, data) {
            let mostEngaging = data.reduce((max, obj) => (obj.eng > max.eng) ? obj : max, data[0] || {name: '-', eng: 0});
            
            const lang = currentLang;
            let report = '';

            if (lang === 'ar') {
                const breakdown = data.map(p => `- ${p.name}: ${p.detailsStr}`).join('\n\n');
                report = `Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ù‚Ù…ÙŠ - ${month}

Ø§Ù„Ø³ÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±ØŒ
ØªØ­ÙŠØ§ØªÙŠØŒ

Ø¥Ù„ÙŠÙƒ Ù…Ù„Ø®Øµ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†ØµØ§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© (Digital Ecosystem):

1. Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ø§Ù…:
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª/Ø§Ù„ÙˆØµÙˆÙ„: ${totalReach.toLocaleString()}
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„ (Likes, Comments, Shares): ${totalEng.toLocaleString()}

2. Ø£Ø¨Ø±Ø² Ø§Ù„Ù…Ù†ØµØ§Øª:
- ğŸ† Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ù†ØªØ´Ø§Ø±Ø§Ù‹: ${topPlatform.name}
- ğŸ”¥ Ø§Ù„Ø£ÙƒØ«Ø± ØªÙØ§Ø¹Ù„Ø§Ù‹: ${mostEngaging.name}

3. Ø§Ù„ØªÙØ§ØµÙŠÙ„:
${breakdown}

Ù…Ø¹ Ø§Ù„ØªØ­ÙŠØ©.`;
            } else {
                const breakdown = data.map(p => `- ${p.name}: ${p.detailsStr}`).join('\n\n');
                report = `Subject: Digital Performance Report - ${month}

Dear Manager,
Greetings,

Here is the summary of our Digital Ecosystem performance:

1. Overview:
- Total Reach/Views: ${totalReach.toLocaleString()}
- Total Engagement: ${totalEng.toLocaleString()}

2. Top Performers:
- ğŸ† Highest Reach: ${topPlatform.name}
- ğŸ”¥ Highest Engagement: ${mostEngaging.name}

3. Breakdown:
${breakdown}

Best regards.`;
            }

            document.getElementById('emailTemplate').value = report;
        }

        function copyEmail() {
            document.getElementById("emailTemplate").select();
            document.execCommand("copy");
            alert(currentLang === 'ar' ? "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ!" : "Text Copied!");
        }

        // Initialize
        window.onload = function() {
            renderForm();
            initChart();
        };

    </script>
</body>
</html>
